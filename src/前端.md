
[toc]

# 前端开发(更新中)

## 一、开发流程

### 启动项目

```bash
  npm install 或 yarn install
  
  npm run start 或 yarn run start
```

### 新增页面

在 ```src/pages``` 下新建 ```Attach``` 文件夹，同时在此文件夹中新建 ```CategoryList.js```

目录结构如下：


```bash
├── pages   
│   ├── Attach
│   │   └── CategoryList.js
```



实现简单页面：
 
 ```js
 // CategoryList.js
import React from 'react';

class CategoryList extends React.Component {
  constructor(props) {
    super(props);
  }
  render() {
    return (
      <div>Hello</div>
    );
  }
}

export default CategoryList;
```
### 配置路由


修改 ```config/router.config.js```， 配置路由地址


```js
  ......
  {
    path: '/',
    component: '../pages/index.js',
    Routes: ['src/pages/Authorized'],
    authority: ['admin', 'user'],
    routes: [
      // attach
      {
        path: '/attach',
        icon: 'cloud-upload',
        name: 'attach',
        routes: [
          {
            path: '/attach/categorylist',
            name: 'categorylist',
            component: './Attach/CategoryList',
          },
        ],
      },
    ......
```

其中icon为显示的图标 [图标列表](https://ant.design/components/icon-cn/)


### 配置菜单

菜单默认会根据 ```router.config.js``` 自动生成，但前端工程目前已改造为从服务端请求数据

开发时可修改 ```mock/menu.js``` 模拟服务端返回的数据

```js
const menus = [
......
  {
    id: 5,
    path: '/attach',
    name: 'attach',
    icon: 'cloud-upload',
    parentId: 0,
  },
  {
    id: 6,
    path: '/attach/categorylist',
    name: 'categorylist',
    parentId: 5,
  },
......
```

编译后查看系统可看到对应菜单，菜单名称需要进行国际化配置


### 国际化

引入国际化组件

```
import { FormattedMessage, formatMessage } from 'umi/locale';
```

其中```FormattedMessage```是标签 ```formatMessage```是函数

```js
import React from 'react';
import { FormattedMessage, formatMessage } from 'umi/locale';

class CategoryList extends React.Component {
  constructor(props) {
    super(props);
  }
  render() {
    return (
      <div>
        <FormattedMessage id="sys.attach.category-name" />
        {formatMessage({ id: 'sys.attach.category-name' })}
      </div>
    );
  }
}

export default CategoryList;
```

```FormattedMessage``` 标签可配置默认值属性 ```defaultMessage```

```js
<FormattedMessage id="sys.attach.category-name" defaultMessage="Category Name" />
```


国际化数据目前已改造为从服务端请求数据

开发时可修改 ```mock/locales.js``` 模拟服务器返回的数据，```zhCN、enUs```分别为中英文环境数据

```js
const zhCN = {
  ......
  'sys.attach.category-name': '目录名称',
  'menu.attach': '附件管理',
  'menu.attach.categorylist': '目录管理',
  ......
};

const enUs = {
  ......
  'sys.attach.category-name': 'Category Name',
  'menu.attach': 'Attach',
  'menu.attach.categorylist': 'Category List',
  ......
};
```

### 定义 model

前端代码结构分为三层

- Page 负责与用户直接打交道：渲染页面、接受用户的操作输入，侧重于展示型交互性逻辑。
- Model 负责处理业务逻辑，为 Page 做数据、状态的读写、变换、暂存等。
- Service 负责与 HTTP 接口对接，进行纯粹的数据读写。

修改页面，模拟一些数据

```js
//CategoryList.js
import React from 'react';

class CategoryList extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      data: [
        {
          key: '1',
          categoryName: 'EXCEL导入公用目录',
          sourceType: 'EXCEL_PUBLIC_FOLDER',
          path: '	D:/excelFile'
        },
        {
          key: '2',
          categoryName: '报表生成EXCEL存放目录',
          sourceType: 'EXCEL_BRIT_FOLDER',
          path: '	D:/britExcelFile'
        }]
    }
  }

  render() {
    return (
      <div>
        {
          this.state.data.map(data => {
            return (
              <div>{data.categoryName} {data.sourceType} {data.path}</div>
            );
          })
        }
      </div>
    );
  }
}

export default CategoryList;


```

现在的数据是直接定义在代码中的，接下来我们创建model

```Attach```文件夹下新建```model.js```文件

```js
//model.js
export default {
  namespace: 'categoryList',
  state: {
    data: [
      {
        key: '1',
        categoryName: 'EXCEL导入公用目录',
        sourceType: 'EXCEL_PUBLIC_FOLDER',
        path: '	D:/excelFile'
      }, {
        key: '2',
        categoryName: '报表生成EXCEL存放目录',
        sourceType: 'EXCEL_BRIT_FOLDER',
        path: '	D:/britExcelFile'
      }
    ]
  },
  effects: {

  },
  reducers: {

  },
};
```

dva 的 model 对象有几个基本的属性,其中 ```namespace``` 和 ```state``` 是必备的, ```namespace``` 来作为 ```model``` 的唯一标识，state 中就是管理的数据

- ```namespace```：model 的命名空间，只能用字符串。一个大型应用可能包含多个 model，通过namespace区分。
- ```state```：当前 model 状态的初始值，表示当前状态。
- ```reducers```：用于处理同步操作，可以修改 state，由 action 触发。reducer 是一个纯函数，它接受当前的 state 及一个 action 对象。action 对象里面可以包含数据体（payload）作为入参，需要返回一个新的 state。
- ```effects```：用于处理异步操作（例如：与服务端交互）和业务逻辑，也是由 action 触发。但是，它不可以修改 - state，要通过触发 action 调用 reducer 实现对 state 的间接操作。
- ```action```：是 reducers 及 effects 的触发器，一般是一个对象，形如{ type: 'add', payload: todo }，通过 type 属性可以匹配到具体某个 reducer 或者 effect，payload 属性则是数据体，用于传送给 reducer 或 effect。

修改页面

```js
// CategoryList.js
import React from 'react';
import { connect } from 'dva';

class CategoryList extends React.Component {
  constructor(props) {
    super(props);
  }

  render() {
    return (
      <div>
        {
          this.props.categoryList.data.map(data => {
            return (
              <div>{data.categoryName} {data.sourceType} {data.path}</div>
            );
          })
        }
      </div>
    );
  }
}

const mapStateToProps = (state) => ({
  categoryList: state.categoryList,
});

export default connect(mapStateToProps)(CategoryList);
```

- connect 让组件获取到两样东西：model 中的数据和驱动 model 改变的方法（effects和reducers中定义的方法）。
- connect 本质上只是一个 javascript 函数；
- connect 既然是函数，就可以接受入参，第一个入参是最常用的，它需要是一个函数，习惯给它命名叫做 mapStateToProps，把 dva model 中的 state 通过组件的 props 注入给组件。通过实现这个函数，我们就能实现把 dva model 的 state 注入给组件。

继续修改model
```js
//model.js
export default {
  namespace: 'categoryList',
  state: {
    data: [],
  },
  effects: {

  },
  reducers: {
    queryList(state) {
      return {
        ...state,
        data: [
          {
            key: '1',
            categoryName: 'EXCEL导入公用目录',
            sourceType: 'EXCEL_PUBLIC_FOLDER',
            path: '	D:/excelFile'
          }, {
            key: '2',
            categoryName: '报表生成EXCEL存放目录',
            sourceType: 'EXCEL_BRIT_FOLDER',
            path: '	D:/britExcelFile'
          }
        ],
      };
    },
  },
};
```

修改页面

```js
// CategoryList.js
import React from 'react';
import { connect } from 'dva';

class CategoryList extends React.Component {
  
  componentDidMount() {
    this.queryList();
  }

  queryList = () => {
    this.props.dispatch({
      type: 'categoryList/queryList',
    });
  };
  
  constructor(props) {
    super(props);
  }

  render() {
    return (
      <div>
        {
          this.props.categoryList.data.map(data => {
            return (
              <div>{data.categoryName} {data.sourceType} {data.path}</div>
            );
          })
        }
      </div>
    );
  }
}

const mapStateToProps = (state) => ({
  categoryList: state.categoryList,
});

export default connect(mapStateToProps)(CategoryList);
```

queryList  函数中调用 dispatch 派发了一个 action，action 的 type 是 categoryList/queryList。categoryList 是 namespace ，queryList 是 reducer 的名字。dispatch 函数接受一个对象作为入参，唯一强制要包含的是 type 字段，string 类型。**dispatch 函数是和 dva model 交互的唯一途径**

```componentDidMount()```在组件挂载之后调用一次


### 请求服务端数据

上面的示例中我们没有在 reducer 中做任何的异步操作，但在实际的开发中，常常需要异步操作配合，比如异步网络请求数据（ajax）等等。但是 reducer 需要是个纯函数，我们不能在 reducer 中写这些逻辑，破坏了这个机制后 dva 将无法工作。这种情况下我们需要使用effect。

将 queryList 调整至 effects 中
```js
//model.js
export default {
  namespace: 'categoryList',
  state: {
    data: [],
  },
  effects: {
    *queryList({ _ }, { call, put }) {
      const data = [{
        key: '1',
        categoryName: 'EXCEL导入公用目录',
        sourceType: 'EXCEL_PUBLIC_FOLDER',
        path: '	D:/excelFile'
      }, {
        key: '2',
        categoryName: '报表生成EXCEL存放目录',
        sourceType: 'EXCEL_BRIT_FOLDER',
        path: '	D:/britExcelFile'
      }];

      yield put({ type: 'saveList', payload: { data: data } });
    },
  },
  reducers: {
    saveList(state, { payload: { data } }) {
      return {
        ...state,
        data,
      }
    },
  },
};
```

 action.type 的构造是 ```namespace 名称``` + ```/``` + ```reducer 名称```，事实上 action.type 也可以是 ```namespace 名称``` + ```/``` + ```effect 名称```。对于视图层来讲，其实并不会感知 effect 和 reducer 的区别
 
 put 是一个函数，put 和 yield 配合使用，用来派发一个 action，和 dispatch 的功能一样,只不过是在 effect 函数中使用而已。
 
下面开始编写service，封装服务端api

 ```Attach```文件夹下新建```service.js```文件
 
 ```js
//service.js
import request from '@/utils/request';

export function queryList() {
  return request('/api/sys/attach/category/query');
}
```

修改model
```js
//model.js
import * as attachService from '@/pages/Attach/service';

export default {
  namespace: 'categoryList',
  state: {
    data: [],
  },
  effects: {
    *queryList({ _ }, { call, put }) {
      const res = yield call(attachService.queryList);
      yield put({ type: 'saveList', payload: { data: res.data } });
    },
  },
  reducers: {
    saveList(state, { payload: { data } }) {
      return {
        ...state,
        data,
      }
    },
  },
};
```

call 是一个函数，和 yield 关键字配合使用处理异步逻辑，call 第一个参数是一个函数，要求函数返回 [Promise](http://es6.ruanyifeng.com/?search=rest&x=0&y=0#docs/promise)，之后的参数是该函数调用时的入参。yield call 调用后就阻塞了，Promise 被解析后，得到异步调用的结果，存储到 res  中，然后程序才能继续进行

### mock 模拟服务端数据

实际开发中，后端的服务不一定马上可用，这就需要本地模拟数据

 ```Attach```文件夹下新建```_mock.js```文件
 
 ```js
let data = [{
  key: '1',
  categoryName: 'EXCEL导入公用目录',
  sourceType: 'EXCEL_PUBLIC_FOLDER',
  path: '	D:/excelFile'
}, {
  key: '2',
  categoryName: '报表生成EXCEL存放目录',
  sourceType: 'EXCEL_BRIT_FOLDER',
  path: '	D:/britExcelFile'
}];

export default {
  'get /api/sys/attach/category/query': function (req, res) {
    setTimeout(() => {
      res.json({
        data: data,
      })
    }, 250)
  }
}
 
 ```
 
 查看页面，可以看到模拟的数据
 

## 二、组件介绍


### Table 表格

官方文档 [Table 表格](https://ant.design/components/table-cn/)

引入Table组件

```js
import { Table } from 'antd';
```

简单示例：

```js
// CategoryList.js
import React from 'react';
import { connect } from 'dva';
import { Table } from 'antd';
import { formatMessage } from 'umi/locale';

class CategoryList extends React.Component {

  componentDidMount() {
    this.queryList();
  }

  queryList = () => {
    this.props.dispatch({
      type: 'categoryList/queryList',
    });
  };

  constructor(props) {
    super(props);
    this.state = {
      columns: [
        {
          title: formatMessage({ id: 'sys.attach.category-name' }),
          dataIndex: 'categoryName',
          key: 'categoryName',
        },
        {
          title: formatMessage({ id: 'sys.attach.source-type' }),
          dataIndex: 'sourceType',
          key: 'sourceType',
        },
        {
          title: formatMessage({ id: 'sys.attach.path' }),
          dataIndex: 'path',
          key: 'path',
        }]
    }
  }

  render() {
    const data = this.props.categoryList.data;
    return (
      <div>
        <Table dataSource={data} columns={this.state.columns} />
      </div>
    );
  }
}

const mapStateToProps = (state) => ({
  categoryList: state.categoryList,
});

export default connect(mapStateToProps)(CategoryList);
```

接下来配置```rowSelection```和```loading```

配置好```rowSelection```后，获取```state```中的```selectedRows```或```selectedRowKeys```就可以得到勾选的数据

定义相关变量和方法
```js
this.state = {
  selectedRows: [],
  selectedRowKeys: [],
}

onSelectChange = (selectedRowKeys, selectedRows) => {
    this.setState({ selectedRowKeys, selectedRows });
}
```
定义```rowSelection```

```js
const rowSelection = {
  selectedRowKeys,
  selectedRows,
  onChange: this.onSelectChange,
};
```

配置好```loading```后，在调用指定model的方法时，Table会进入加载中状态

修改 ```mapStateToProps```方法获取 ```loading```值，```categoryList```是model的namespace

```js
const mapStateToProps = (state) => ({
  categoryList: state.categoryList,
  loading: state.loading.models.categoryList,
});

export default connect(mapStateToProps)(CategoryList);
```

修改后的页面代码：

```js
// CategoryList.js
import React from 'react';
import { connect } from 'dva';
import { Table } from 'antd';
import { formatMessage } from 'umi/locale';

class CategoryList extends React.Component {

  componentDidMount() {
    this.queryList();
  }

  queryList = () => {
    this.props.dispatch({
      type: 'categoryList/queryList',
    });
  };

  constructor(props) {
    super(props);
    this.state = {
      selectedRows: [],
      selectedRowKeys: [],
      columns: [
        {
          title: formatMessage({ id: 'sys.attach.category-name' }),
          dataIndex: 'categoryName',
          key: 'categoryName',
        },
        {
          title: formatMessage({ id: 'sys.attach.source-type' }),
          dataIndex: 'sourceType',
          key: 'sourceType',
        },
        {
          title: formatMessage({ id: 'sys.attach.path' }),
          dataIndex: 'path',
          key: 'path',
        }]
    }
  }

  onSelectChange = (selectedRowKeys, selectedRows) => {
    console.log('selectedRowKeys changed: ', selectedRowKeys);
    console.log('selectedRows changed', selectedRows);
    this.setState({ selectedRowKeys, selectedRows });
  }

  render() {
    const { categoryList: { data }, loading } = this.props

    const { selectedRowKeys, selectedRows } = this.state;
    const rowSelection = {
      selectedRowKeys,
      selectedRows,
      onChange: this.onSelectChange,
    };

    return (
      <div>
        <Table
          loading={loading}
          rowSelection={rowSelection}
          dataSource={data}
          columns={this.state.columns}
        />
      </div>
    );
  }
}

const mapStateToProps = (state) => ({
  categoryList: state.categoryList,
  loading: state.loading.models.categoryList,
});

export default connect(mapStateToProps)(CategoryList);
```

### Button 按钮

```Button```使用比较简单，可参考官方文档 [Button 按钮](https://ant.design/components/button-cn/) 

下面添加批量删除按钮

引入```Button```组件

```js
import { Table, Button } from 'antd';
```

页面中定义删除方法

```js
  batchDeleteItem = (e) => {
    const { selectedRowKeys } = this.state;

    this.props.dispatch({
      type: 'categoryList/remove',
      payload: selectedRowKeys,
    }).then((res) => {
      this.setState({
        selectedRows: [],
        selectedRowKeys: [],
      });

      this.queryList();
    });
  }
```

删除后清空state中的```selectedRows```和```selectedRowKeys```，然后调用查询方法


按钮绑定方法

```xml
<Button onClick={this.batchDeleteItem}>Delete</Button>
```

effects中添加remove方法

```js
*remove({ payload }, { call, put }) {
  const res = yield call(attachService.deleteItem, payload);
  return res;
},
```

service中添加方法

```js
export function deleteItem(params) {
  return request('/api/sys/attach/category/delete', {
    method: 'DELETE',
    body: {
      params
    },
  });
}
```

mock模拟服务端

```js
  'delete /api/sys/attach/category/delete': function (req, res, next) {
    const { params } = req.body;
    data = data.filter(item => params.indexOf(item.key) === -1);
    setTimeout(() => {
      res.json({
        success: true,
      })
    }, 250)

  },

```

完整代码：

```js
// CategoryList.js
import React from 'react';
import { connect } from 'dva';
import { Table, Button } from 'antd';
import { formatMessage } from 'umi/locale';

class CategoryList extends React.Component {

  constructor(props) {
    super(props);
    this.state = {
      buttonLoading: false,
      selectedRows: [],
      selectedRowKeys: [],
      columns: [
        {
          title: formatMessage({ id: 'sys.attach.category-name' }),
          dataIndex: 'categoryName',
          key: 'categoryName',
        },
        {
          title: formatMessage({ id: 'sys.attach.source-type' }),
          dataIndex: 'sourceType',
          key: 'sourceType',
        },
        {
          title: formatMessage({ id: 'sys.attach.path' }),
          dataIndex: 'path',
          key: 'path',
        }]
    }
  }

  componentDidMount() {
    this.queryList();
  }

  queryList = () => {
    this.props.dispatch({
      type: 'categoryList/queryList',
    });
  };

  onSelectChange = (selectedRowKeys, selectedRows) => {
    this.setState({ selectedRowKeys, selectedRows });
  }

  batchDeleteItem = (e) => {
    this.setState({ buttonLoading: true });
    const { selectedRowKeys } = this.state;

    this.props.dispatch({
      type: 'categoryList/remove',
      payload: selectedRowKeys,
    }).then((res) => {
      this.setState({
        selectedRows: [],
        selectedRowKeys: [],
        buttonLoading: false
      });

      this.queryList();
    })
  }

  render() {

    const { categoryList: { data }, loading } = this.props

    const { selectedRowKeys, selectedRows, buttonLoading } = this.state;
    const rowSelection = {
      selectedRowKeys,
      selectedRows,
      onChange: this.onSelectChange,
    };

    return (
      <div>
        {selectedRows.length > 0 && (
          <Button onClick={this.batchDeleteItem} loading={buttonLoading}>批量删除</Button>
        )}
        <Table
          loading={loading}
          rowSelection={rowSelection}
          dataSource={data}
          columns={this.state.columns}
        />
      </div>
    );
  }
}

const mapStateToProps = (state) => ({
  categoryList: state.categoryList,
  loading: state.loading.models.categoryList,
});

export default connect(mapStateToProps)(CategoryList);

```


```js
//model.js
import * as attachService from '@/pages/Attach/service';

export default {
  namespace: 'categoryList',
  state: {
    data: [],
  },
  effects: {
    *queryList({ _ }, { call, put }) {
      const res = yield call(attachService.queryList);
      yield put({ type: 'saveList', payload: { data: res.data } });
    },
    *remove({ payload }, { call, put }) {
      const res = yield call(attachService.deleteItem, payload);
      return res;
    },
  },
  reducers: {
    saveList(state, { payload: { data } }) {
      return {
        ...state,
        data,
      }
    },
  },
};
```

```js

//service.js
import request from '@/utils/request';

export function queryList() {
  return request('/api/sys/attach/category/query');
}

export function deleteItem(params) {
  return request('/api/sys/attach/category/delete', {
    method: 'DELETE',
    body: {
      params
    },
  });
}
```

```js
//_mock.js
let data = [{
  key: '1',
  categoryName: 'EXCEL导入公用目录',
  sourceType: 'EXCEL_PUBLIC_FOLDER',
  path: '	D:/excelFile'
}, {
  key: '2',
  categoryName: '报表生成EXCEL存放目录',
  sourceType: 'EXCEL_BRIT_FOLDER',
  path: '	D:/britExcelFile'
}, {
  key: '3',
  categoryName: '目录3',
  sourceType: 'D3',
  path: '	D:/britExcelFile'
}];

export default {
  'get /api/sys/attach/category/query': function (req, res) {
    setTimeout(() => {
      res.json({
        data: data,
      })
    }, 250)
  },
  'delete /api/sys/attach/category/delete': function (req, res, next) {
    const { params } = req.body;
    data = data.filter(item => params.indexOf(item.key) === -1);
    setTimeout(() => {
      res.json({
        success: true,
      })
    }, 250)
  },
}
```

### Form 表单

官方文档 [Form 表单](https://ant.design/components/form-cn/)

引入组件

```js
import { Table, Modal, Button, Form, Input } from 'antd';

const FormItem = Form.Item;
```

将页面与表单进行关联

```js
export default connect(mapStateToProps)(Form.create()(CategoryList));
```

这段代码的作用是创建一个高阶组件，为页面组件提供表单所需要的内容(```this.props.form```)。


下面我们开始添加查询区域

定义表单

```xml
render() {
    const { form: { getFieldDecorator } } = this.props;

    // ...

    return (
      <div>
        <Form onSubmit={this.handleSearch} layout="inline">
          <FormItem label="目录名称">
            {getFieldDecorator('categoryName')(<Input placeholder="请输入" />)}
          </FormItem>
          <FormItem label="来源类型">
            {getFieldDecorator('sourceType')(<Input placeholder="请输入" />)}
          </FormItem>
          <FormItem label="存储路径">
            {getFieldDecorator('path')(<Input placeholder="请输入" />)}
          </FormItem>
          <Button type="primary" htmlType="submit"> 查询</Button>
        </Form>
        
        {/* ... */}
        
      </div>
    );
  }
}

```

我们可以看到表单组件是通过 ```Form``` 与 ```Form.Item``` (我们之前定义了 ```FormItem = Form.item```) 配合使用，其中每一个 Form.Item 都是一个表单域。而 ```getFieldDecorator``` 是用于将包裹的组件与表单进行双向绑定使用。


定义提交方法

```js
  handleSearch = (e) => {
    e.preventDefault();
    const { form: { validateFields } } = this.props;

    validateFields((err, values) => {
      if (!err) {
        this.setState({
          formValues: values,
        });
        this.queryList();
      }
    });

  };
```

```e.preventDefault()```防止表单打开url

```validateFields```方法验证表单是否完成填写，通过便执行查询操作

#### 栅格布局

下面我们给表单添加布局([栅格布局](https://ant.design/components/grid-cn/)) ,使用方式和bootstrap相似，需要注意由一行由```12```列扩展到了```24```列

引入```Row```和```Col```
```js
import { Table, Modal, Row, Col, Button, Form, Input } from 'antd';
```

给表单配置布局

```
<Form onSubmit={this.handleSearch} layout="inline">
  <Row gutter={16}>
    <Col span={6}>
      <FormItem label="目录名称">
        {getFieldDecorator('categoryName')(<Input placeholder="请输入" />)}
      </FormItem>
    </Col>
    <Col span={6}>
      <FormItem label="来源类型">
        {getFieldDecorator('sourceType')(<Input placeholder="请输入" />)}
      </FormItem>
    </Col>
    <Col span={6}>
      <FormItem label="存储路径">
        {getFieldDecorator('path')(<Input placeholder="请输入" />)}
      </FormItem>
    </Col>
    <Col span={6}>
      <Button type="primary" htmlType="submit">查询</Button>
    </Col>
  </Row>
</Form>
```
#### Modal 对话框

接下来使用 [Modal 对话框](https://ant.design/components/modal-cn/) 实现新建和编辑功能

为避免和查询表单字段冲突，新定义一个组件


```Attach```文件夹下新建```CategoryModal.js```

```js
//CategoryModal.js
import React from 'react';
import {
  Modal,
  Form,
  Input,
} from 'antd';

const FormItem = Form.Item;

@Form.create()
export default class CategoryModal extends React.Component {

  constructor(props) {
    super(props);
    const { values } = props;
    this.state = {
      values: values
    };
  }

  okHandle = () => {
    const { form, handleOk } = this.props;
    const { values: oldValue } = this.state;
    form.validateFields((err, fieldsValue) => {
      if (err) {
        return;
      }
      const formVals = { ...oldValue, ...fieldsValue };
      // form.resetFields();
      handleOk(formVals);
    });
  };

  render() {
    const { modalVisible, form: { getFieldDecorator }, handleCancel, title } = this.props;
    const { values } = this.state;
    return (
      <Modal
        destroyOnClose
        title={title}
        visible={modalVisible}
        onOk={this.okHandle}
        onCancel={handleCancel}
      >
        <Form>
          <FormItem labelCol={{ span: 5 }} wrapperCol={{ span: 15 }} label="目录名称">
            {getFieldDecorator('categoryName', {
              rules: [{ required: true }],
              initialValue: values.categoryName
            })(
              <Input />
            )}
          </FormItem>
          <FormItem labelCol={{ span: 5 }} wrapperCol={{ span: 15 }} label="来源类型">
            {getFieldDecorator('sourceType', {
              rules: [{ required: true }],
              initialValue: values.sourceType
            })(
              <Input />
            )}
          </FormItem>
          <FormItem labelCol={{ span: 5 }} wrapperCol={{ span: 15 }} label="存储路径">
            {getFieldDecorator('path', {
              rules: [{ required: true }],
              initialValue: values.path
            })(
              <Input />
            )}
          </FormItem>
        </Form>
      </Modal>
    );
  }

}

```

使用新定义的组件实现新建和编辑页面

```
import CategoryModal from './CategoryModal.js';
```

```
const { updateVisible, currentValues } = this.state;

const parentMethods = {
  handleOk: this.handleOk,
  handleCancel: this.handleCancel,
};

```

```
<CategoryModal {...parentMethods} modalVisible={updateVisible} values={currentValues} title={'编辑目录'} />


```


### Select 选择器

官方文档 [Select选择器](https://ant.design/components/select-cn/)


一般用法
```
<Select>
    <Option value='ACTV'>有效</Option>
    <Option value='EXPR'>过期</Option>
    <Option value='LOCK'>已锁定</Option>
</Select>

```

动态加载```Option```

```

const statusMap = [
  { text: '有效', value: 'ACTV' },
  { text: '过期', value: 'EXPR' },
  { text: '已锁定', value: 'LOCK' },
]

......

<Select>
{
  statusMap.map(item => {
    return (
      <Select.Option value={item.value} key={item.value}>{item.text}</Select.Option>
    );
  })
}
</Select>

```

### Pagination 分页

官方文档 [Pagination 分页](https://ant.design/components/pagination-cn/)


定义分页器

```js
this.state = {
  pagination: {
    showSizeChanger: true,
    showQuickJumper: true
  },
  .......

```

```
  <Table
    pagination={this.state.pagination}
    loading={loading}
    rowSelection={rowSelection}
    dataSource={data}
    columns={columns}
  />
```


### Alert 警告提示

官方文档 [Alert 警告提示](https://ant.design/components/alert-cn/)


在```Table```前添加一个提示当前选中行数的```Alert```

```
import { Alert } from 'antd';
import { Fragment } from 'react';
```

```
<Alert
  message={
    <Fragment>
      已选择 <a style={{ fontWeight: 600 }}>{selectedRowKeys.length}</a> 项
    <a onClick={this.cleanSelectedKeys} style={{ marginLeft: 24 }}>清空</a>
    </Fragment>
  }
  type="info"
  showIcon
/>

```

### Dropdown 下拉菜单

官方文档 [Dropdown 下拉菜单](https://ant.design/components/dropdown-cn/)

页面批量操作按钮过多时，使用```Dropdown```收纳操作元素

和 [Menu](https://ant.design/components/menu-cn/) 一起使用，实现更多操作按钮


引入组件
```
import { Dropdown, Menu, Icon } from 'antd';
```

定义下拉菜单内容

```
const menu = (
  <Menu onClick={this.handleMenuClick} selectedKeys={[]}>
    <Menu.Item key="method1">批量操作1</Menu.Item>
    <Menu.Item key="method2">批量操作2</Menu.Item>
  </Menu>
);

```

定义点击方法
```
  handleMenuClick = e => {
    const { selectedRows } = this.state;

    if (!selectedRows) {
      return;
    }
    switch (e.key) {
      case 'method1':
        console.log('method1');
        break;
      case 'method2':
        console.log('method2');
        break;
      default:
        break;
    }
  };

```

定义下拉菜单

```
{selectedRows.length > 0 && (
  <span>
    <Button onClick={this.batchDeleteItem} loading={buttonLoading}>批量删除</Button>
    <Dropdown overlay={menu}>
      <Button>
        更多操作 <Icon type="down" />
      </Button>
    </Dropdown>
  </span>
)}

```

### 自定义样式

```Attach```目录下添加```CategoryList.less```文件

```
//CategoryList.less
@import '~antd/lib/style/themes/default.less';
@import '~@/utils/utils.less';
.tableList {
    .tableListOperator {
        margin-bottom: 16px;
        .tableArea {
            margin-top: 16px
        }
        button {
            margin-right: 8px;
        }
    }
}

.tableListForm {
    :global {
        .ant-form-item {
            margin-bottom: 24px;
            margin-right: 0;
            display: flex;
            >.ant-form-item-label {
                width: auto;
                line-height: 32px;
                padding-right: 8px;
            }
            .ant-form-item-control {
                line-height: 32px;
            }
        }
        .ant-form-item-control-wrapper {
            flex: 1;
        }
    }
    .submitButtons {
        display: block;
        white-space: nowrap;
        margin-bottom: 24px;
    }
}

```

页面中引入```style```并使用
```
import styles from './CategoryList.less';
```

```
<div className={styles.tableList}>
  <div className={styles.tableListForm}>{this.renderSimpleForm()}</div>
  <div className={styles.tableListOperator}>
    <Button icon="plus" type="primary" onClick={this.showModal}>
      新建
    </Button>
    {selectedRows.length > 0 && (<Button onClick={this.batchDeleteItem} loading={buttonLoading}>批量删除</Button>)}
    <div className={styles.tableArea}>
      <Table
        loading={loading}
        rowSelection={rowSelection}
        dataSource={data}
        columns={this.state.columns}
      />
    </div>
  </div>
</div>

```


## 三、其他

### 页面跳转

引入 ```routerRedux```


```js
import {routerRedux} from 'dva/router';
```

页面中

```
this.props.dispatch(routerRedux.push('/dashboard/analysis'));
```

```model```中

```js
yield put(routerRedux.push('/dashboard/analysis'));
```


### 常用ES6语法

完整的 ES6 介绍请参考 http://es6.ruanyifeng.com/

#### 箭头函数

ES6 允许使用```=>```定义函数

```js
var f = v => v;
//等同于
var f = function (v) {
  return v;
};

```

如果箭头函数不需要参数或需要多个参数，就使用一个圆括号代表参数部分

```js
var f = () => 1;
// 等同于
var f = function () { return 1 };

var f = (a, b) => a + b;
// 等同于
var f = function(a, b) {
  return a + b;
};

```

#### 解构赋值

ES6 允许按照一定模式，从数组和对象中提取值，对变量进行赋值

```js
let { a, b } = { a: "aaa", b: "bbb" };
// a = "aaa"
// b = "bbb"
```


### setState回调方法


``` this.setState({    }) ```是异步方法

回调方法写法
```
this.setState({    }, () => { } )
```


## 四、完整代码参考

### 目录结构

目录结构如下

```bash
├── pages   
│   ├── Attach
│   │   ├── CategoryList.js
│   │   ├── CategoryModal.js
│   │   ├── CategoryList.less
│   │   ├── model.js
│   │   ├── service.js
│   │   └── _mock.js
```

### CategoryList.js

```js
// CategoryList.js
import React, { Fragment } from 'react';
import { connect } from 'dva';
import { Table, Row, Col, Button, Form, Input, Card, Alert, Dropdown, Menu, Icon } from 'antd';
import { formatMessage } from 'umi/locale';
import styles from './CategoryList.less';
import CategoryModal from './CategoryModal';

const FormItem = Form.Item;

class CategoryList extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      pagination: {
        showSizeChanger: true,
        showQuickJumper: true,
      },
      currentValues: {},
      buttonLoading: false,
      selectedRows: [],
      selectedRowKeys: [],
      columns: [
        {
          title: formatMessage({ id: 'sys.attach.category-name' }),
          dataIndex: 'categoryName',
          key: 'categoryName',
        },
        {
          title: formatMessage({ id: 'sys.attach.source-type' }),
          dataIndex: 'sourceType',
          key: 'sourceType',
        },
        {
          title: formatMessage({ id: 'sys.attach.path' }),
          dataIndex: 'path',
          key: 'path',
        },
        {
          title: '操作',
          render: (text, record) => <a onClick={() => this.handleUpdate(record)}>编辑</a>,
        },
      ],
    };
  }

  componentDidMount() {
    this.queryList();
  }

  handleUpdate = record => {
    this.setState({
      currentValues: record || {},
      updateVisible: true,
    });
  };

  queryList = () => {
    const { dispatch } = this.props;
    const { formValues } = this.state;
    dispatch({
      type: 'categoryList/queryList',
      payload: formValues
    });
  };

  onSelectChange = (selectedRowKeys, selectedRows) => {
    this.setState({ selectedRowKeys, selectedRows });
  };

  batchDeleteItem = () => {
    this.setState({ buttonLoading: true });

    const { selectedRowKeys } = this.state;

    const { dispatch } = this.props;

    dispatch({
      type: 'categoryList/remove',
      payload: selectedRowKeys,
    }).then(() => {
      this.setState({
        selectedRows: [],
        selectedRowKeys: [],
        buttonLoading: false,
      });

      this.queryList();
    });
  };

  handleSearch = e => {
    e.preventDefault();
    const {
      form: { validateFields },
    } = this.props;

    validateFields((err, values) => {
      if (err) {
        return;
      }
      this.setState({
        formValues: values,
      }, () => {
        this.queryList();
      });
    });
  };

  handleFormReset = () => {
    const { form } = this.props;
    form.resetFields();
    this.setState({
      formValues: {},
    }, () => {
      this.queryList();
    });

  };

  // eslint-disable-next-line react/sort-comp
  renderSimpleForm() {
    const {
      form: { getFieldDecorator },
    } = this.props;
    return (
      <Form onSubmit={this.handleSearch} layout="inline">
        <Row gutter={16}>
          <Col span={6}>
            <FormItem label="目录名称">
              {getFieldDecorator('categoryName')(<Input placeholder="请输入" />)}
            </FormItem>
          </Col>
          <Col span={6}>
            <FormItem label="来源类型">
              {getFieldDecorator('sourceType')(<Input placeholder="请输入" />)}
            </FormItem>
          </Col>
          <Col span={6}>
            <FormItem label="存储路径">
              {getFieldDecorator('path')(<Input placeholder="请输入" />)}
            </FormItem>
          </Col>
          <Col span={6}>
            <Button type="primary" htmlType="submit">
              查询
            </Button>
            <Button style={{ marginLeft: 8 }} onClick={this.handleFormReset}>
              重置
            </Button>
          </Col>
        </Row>
      </Form>
    );
  }

  showModal = () => {
    this.setState({ visible: true });
  };

  handleOk = fields => {
    const { dispatch } = this.props;
    dispatch({
      type: 'categoryList/submit',
      payload: fields,
    }).then(() => {
      this.setState({
        visible: false,
        updateVisible: false,
        currentValues: {},
      });
      this.queryList();
    });
  };

  handleCancel = () => {
    this.setState({
      visible: false,
      updateVisible: false,
      currentValues: {},
    });
  };

  cleanSelectedKeys = () => {
    this.setState({
      selectedRows: [],
      selectedRowKeys: [],
    });
  };

  handleMenuClick = e => {
    const { selectedRows } = this.state;

    if (!selectedRows) {
      return;
    }
    switch (e.key) {
      case 'method1':
        console.log('method1');
        break;
      case 'method2':
        console.log('method2');
        break;
      default:
        break;
    }
  };

  render() {
    const {
      categoryList: { data },
      loading,
    } = this.props;

    const {
      selectedRowKeys,
      selectedRows,
      buttonLoading,
      visible,
      updateVisible,
      currentValues,
      pagination,
      columns,
    } = this.state;

    const menu = (
      <Menu onClick={this.handleMenuClick} selectedKeys={[]}>
        <Menu.Item key="method1">批量操作1</Menu.Item>
        <Menu.Item key="method2">批量操作2</Menu.Item>
      </Menu>
    );

    const rowSelection = {
      selectedRowKeys,
      selectedRows,
      onChange: this.onSelectChange,
    };

    const parentMethods = {
      handleOk: this.handleOk,
      handleCancel: this.handleCancel,
    };

    return (
      <div>
        <Card bordered={false}>
          <div className={styles.tableList}>
            <div className={styles.tableListForm}>{this.renderSimpleForm()}</div>
            <div className={styles.tableListOperator}>
              <div className={styles.tableButton}>
                <Button icon="plus" type="primary" onClick={this.showModal}>
                  新建
                </Button>
                {selectedRows.length > 0 && (
                  <span>
                    <Button onClick={this.batchDeleteItem} loading={buttonLoading}>
                      批量删除
                    </Button>
                    <Dropdown overlay={menu}>
                      <Button>
                        更多操作 <Icon type="down" />
                      </Button>
                    </Dropdown>
                  </span>
                )}
              </div>
              <div className={styles.tableAlert}>
                <Alert
                  message={
                    <Fragment>
                      已选择 <a style={{ fontWeight: 600 }}>{selectedRowKeys.length}</a> 项
                      <a onClick={this.cleanSelectedKeys} style={{ marginLeft: 24 }}>
                        清空
                      </a>
                    </Fragment>
                  }
                  type="info"
                  showIcon
                />
              </div>
              <Table
                rowKey={record => record.id}
                pagination={pagination}
                loading={loading}
                rowSelection={rowSelection}
                dataSource={data}
                columns={columns}
              />
            </div>
          </div>
        </Card>
        <CategoryModal {...parentMethods} modalVisible={visible} values={{}} title="新建目录" />
        {currentValues && Object.keys(currentValues).length ? (
          <CategoryModal
            {...parentMethods}
            modalVisible={updateVisible}
            values={currentValues}
            title="编辑目录"
          />
        ) : null}
      </div>
    );
  }
}

const mapStateToProps = state => ({
  categoryList: state.categoryList,
  loading: state.loading.models.categoryList,
});

export default connect(mapStateToProps)(Form.create()(CategoryList));

```


### CategoryModal.js

```
// CategoryModal.js
import React from 'react';
import { Modal, Form, Input } from 'antd';

const FormItem = Form.Item;

@Form.create()
class CategoryModal extends React.Component {
  constructor(props) {
    super(props);
    const { values } = props;
    this.state = {
      values,
    };
  }

  okHandle = () => {
    const { form, handleOk } = this.props;
    const { values: oldValue } = this.state;
    form.validateFields((err, fieldsValue) => {
      if (err) {
        return;
      }
      const formVals = { ...oldValue, ...fieldsValue };
      // form.resetFields();
      handleOk(formVals);
    });
  };

  render() {
    const {
      modalVisible,
      form: { getFieldDecorator },
      handleCancel,
      title,
    } = this.props;
    const { values } = this.state;
    return (
      <Modal
        destroyOnClose
        title={title}
        visible={modalVisible}
        onOk={this.okHandle}
        onCancel={handleCancel}
      >
        <Form>
          <FormItem labelCol={{ span: 5 }} wrapperCol={{ span: 15 }} label="目录名称">
            {getFieldDecorator('categoryName', {
              rules: [{ required: true }],
              initialValue: values.categoryName,
            })(<Input />)}
          </FormItem>
          <FormItem labelCol={{ span: 5 }} wrapperCol={{ span: 15 }} label="来源类型">
            {getFieldDecorator('sourceType', {
              rules: [{ required: true }],
              initialValue: values.sourceType,
            })(<Input />)}
          </FormItem>
          <FormItem labelCol={{ span: 5 }} wrapperCol={{ span: 15 }} label="存储路径">
            {getFieldDecorator('path', {
              rules: [{ required: true }],
              initialValue: values.path,
            })(<Input />)}
          </FormItem>
        </Form>
      </Modal>
    );
  }
}
export default CategoryModal;



```

### CategoryList.less


```
@import '~antd/lib/style/themes/default.less';
@import '~@/utils/utils.less';
.tableList {
    .tableListOperator {
        margin-bottom: 16px;
        .tableButton {
            margin-bottom: 16px
        }
        .tableAlert {
            margin-bottom: 16px
        }
        button {
            margin-right: 8px;
        }
    }
}

.tableListForm {
    :global {
        .ant-form-item {
            margin-bottom: 24px;
            margin-right: 0;
            display: flex;
            >.ant-form-item-label {
                width: auto;
                line-height: 32px;
                padding-right: 8px;
            }
            .ant-form-item-control {
                line-height: 32px;
            }
        }
        .ant-form-item-control-wrapper {
            flex: 1;
        }
    }
    .submitButtons {
        display: block;
        white-space: nowrap;
        margin-bottom: 24px;
    }
}
```

### model.js


```
import * as attachService from './service';

export default {
  namespace: 'categoryList',
  state: {
    data: [],
  },
  effects: {
    *queryList({ payload }, { call, put }) {
      const res = yield call(attachService.queryList, payload);
      yield put({ type: 'saveList', payload: { data: res.data } });
    },
    *remove({ payload }, { call }) {
      const res = yield call(attachService.deleteItem, payload);
      return res;
    },
    *submit({ payload }, { call }) {
      let res;
      if (payload.id) {
        res = yield call(attachService.updateItem, payload);
      } else {
        res = yield call(attachService.addItem, payload);
      }
      return res;
    },
  },
  reducers: {
    saveList(
      state,
      {
        payload: { data },
      }
    ) {
      return {
        ...state,
        data,
      };
    },
  },
};


```

### service.js

```
import request from '@/utils/request';
import { stringify } from 'qs';

export function queryList(params) {
  return request(`/api/sys/attach/category/query?${stringify(params)}`);
}

export function deleteItem(params) {
  return request('/api/sys/attach/category/delete', {
    method: 'DELETE',
    body: {
      params,
    },
  });
}

export function addItem(params) {
  return request('/api/sys/attach/category/add', {
    method: 'POST',
    body: {
      params,
    },
  });
}

export function updateItem(params) {
  return request('/api/sys/attach/category/update', {
    method: 'POST',
    body: {
      params,
    },
  });
}




```


### _mock.js

```

import { parse } from 'url';

let data = [
  {
    id: 1,
    categoryName: 'EXCEL导入公用目录',
    sourceType: 'EXCEL_PUBLIC_FOLDER',
    path: 'D:/excelFile',
  },
  {
    id: 2,
    categoryName: '报表生成EXCEL存放目录',
    sourceType: 'EXCEL_BRIT_FOLDER',
    path: 'D:/britExcelFile',
  },
  {
    id: 3,
    categoryName: '目录3',
    sourceType: 'D3',
    path: 'D:/britExcelFile',
  },
];

export default {
  // eslint-disable-next-line func-names
  'get /api/sys/attach/category/query': function (req, res, u) {

    let url = u;
    if (!url || Object.prototype.toString.call(url) !== '[object String]') {
      url = req.url; // eslint-disable-line
    }

    const params = parse(url, true).query;

    let dataSource = data;

    if (params.categoryName) {
      dataSource = dataSource.filter(d => d.categoryName.indexOf(params.categoryName) > -1);
    }

    if (params.sourceType) {
      dataSource = dataSource.filter(d => d.sourceType.indexOf(params.sourceType) > -1);
    }

    if (params.path) {
      dataSource = dataSource.filter(d => d.path.indexOf(params.path) > -1);
    }

    setTimeout(() => {
      res.json({
        data: dataSource,
      });
    }, 250);
  },
  // eslint-disable-next-line func-names
  'delete /api/sys/attach/category/delete': function (req, res) {
    const { params } = req.body;
    data = data.filter(item => params.indexOf(item.id) === -1);
    setTimeout(() => {
      res.json({
        success: true,
      });
    }, 250);
  },
  // eslint-disable-next-line func-names
  'post /api/sys/attach/category/add': function (req, res) {
    data = [
      ...data,
      {
        ...req.body.params,
        id: data[data.length - 1].id + 1,
      },
    ];

    setTimeout(() => {
      res.json({
        success: true,
      });
    }, 250);
  },
  // eslint-disable-next-line func-names
  'post /api/sys/attach/category/update': function (req, res) {
    const {
      params: { id },
    } = req.body;

    data = data.map(item => {
      if (item.id === id) {
        Object.assign(item, req.body.params);
        return item;
      }
      return item;
    });

    setTimeout(() => {
      res.json({
        success: true,
      });
    }, 250);
  },
};



```